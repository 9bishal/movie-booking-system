{% extends 'base/base.html' %}

{% block title %}Booking Summary - Razorpay{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0"><i class="fas fa-list-check me-2"></i>Review Your Booking</h4>
                    <p class="mb-0 mt-2 small opacity-75">
                        <i class="fas fa-info-circle me-1"></i> Your seats will be reserved for 12 minutes once you proceed to payment
                    </p>
                </div>
                <div class="card-body p-4">
                    <div class="row align-items-center mb-4">
                        <div class="col-md-3 text-center mb-3 mb-md-0">
                            {% if movie.poster %}
                            <img src="{{ movie.poster.url }}" alt="{{ movie.title }}" class="img-fluid rounded shadow" style="max-height: 200px;">
                            {% else %}
                            <div class="bg-light rounded d-flex align-items-center justify-content-center mx-auto shadow" style="width: 150px; height: 200px;">
                                <i class="fas fa-film fa-3x text-muted"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-9">
                            <h2 class="h3 text-primary">{{ movie.title }}</h2>
                            <p class="lead mb-2">{{ showtime.screen.theater.name }}</p>
                            <div class="d-flex flex-wrap gap-3 text-muted">
                                <span><i class="fas fa-calendar-day me-1"></i> {{ showtime.get_formatted_date }}</span>
                                <span><i class="fas fa-clock me-1"></i> {{ showtime.get_formatted_time }}</span>
                                <span><i class="fas fa-door-open me-1"></i> {{ showtime.screen.name }}</span>
                                <span><i class="fas fa-language me-1"></i> {{ movie.language.name }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="bg-light p-4 rounded-3 h-100">
                                <h5 class="mb-4 text-dark border-bottom pb-2">Seat Details</h5>
                                <div class="mb-3">
                                    <span class="text-muted d-block">Number of Seats:</span>
                                    <span class="fs-4 fw-bold">{{ seat_count }}</span>
                                </div>
                                <div>
                                    <span class="text-muted d-block mb-2">Selected Seats:</span>
                                    <div class="d-flex flex-wrap gap-2">
                                        {% for seat in seat_ids %}
                                        <span class="badge bg-white text-primary border border-primary px-3 py-2 fs-6">{{ seat }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="bg-light p-4 rounded-3 h-100">
                                <h5 class="mb-4 text-dark border-bottom pb-2">Price Summary</h5>
                                <table class="table table-borderless mb-0">
                                    <tr>
                                        <td class="ps-0">Base Ticket Price:</td>
                                        <td class="text-end pe-0">‚Çπ{{ price_details.base_price }}</td>
                                    </tr>
                                    <tr>
                                        <td class="ps-0 text-muted small">Convenience Fee:</td>
                                        <td class="text-end pe-0 text-muted small">‚Çπ{{ price_details.convenience_fee }}</td>
                                    </tr>
                                    <tr>
                                        <td class="ps-0 text-muted small">Tax (GST 18%):</td>
                                        <td class="text-end pe-0 text-muted small">‚Çπ{{ price_details.tax_amount }}</td>
                                    </tr>
                                    <tr class="border-top">
                                        <td class="ps-0 fw-bold fs-5">Amount Payable:</td>
                                        <td class="text-end pe-0 fw-bold fs-5 text-primary">‚Çπ{{ total_amount }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-white p-4 border-0">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <!-- <a href="{% url 'select_seats' showtime.id %}" class="btn btn-outline-secondary btn-lg w-100">
                                <i class="fas fa-chevron-left me-2"></i>Change Seats
                            </a> -->
                        </div>
                        <div class="col-md-6">
                            <button id="confirm-booking-btn" class="btn btn-success btn-lg w-100 shadow">
                                Proceed to pay with Razorpay <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <p class="text-center text-muted small mt-4">
                <i class="fas fa-info-circle me-1"></i> 
                By clicking "Proceed to pay with Razorpay", you agree to our Terms & Conditions.
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ seat_ids|json_script:"seat-data" }}
<!-- üöÄ Razorpay Library: Load early for faster modal display -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
// ‚è±Ô∏è Global timer variables
let timerInterval = null;
let bookingExpiryTime = null;
let razorpayInstance = null;

//  WHY: Direct Razorpay Modal Opening (No Intermediate Page)
// Creates booking and opens Razorpay modal immediately
// This starts the 12-minute timer and reserves seats in Redis
async function createBookingAndOpenPayment(showtimeId, seatIds) {
    try {
        const response = await fetch(`/bookings/api/create-booking/${showtimeId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ seat_ids: seatIds })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // ‚úÖ SUCCESS: Seats are now reserved for 12 minutes
            // Open Razorpay modal directly (skip intermediate payment page)
            return data;
        } else {
            return { success: false, error: data.error || 'Booking creation failed' };
        }
    } catch (error) {
        console.error('Booking creation error:', error);
        return { success: false, error: 'Connection error' };
    }
}

// ‚è±Ô∏è WHY: Timer Monitoring for Auto-Close
// Monitors booking expiry and closes Razorpay modal if time runs out
function startExpiryTimer(bookingId, expirySeconds) {
    // Calculate exact expiry time
    bookingExpiryTime = Date.now() + (expirySeconds * 1000);
    
    console.log(`‚è±Ô∏è Timer started: ${expirySeconds} seconds (${Math.floor(expirySeconds/60)} minutes)`);
    
    // Clear any existing timer
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    
    // Check every second
    timerInterval = setInterval(() => {
        const now = Date.now();
        const remainingMs = bookingExpiryTime - now;
        const remainingSecs = Math.floor(remainingMs / 1000);
        
        // Log remaining time every minute
        if (remainingSecs > 0 && remainingSecs % 60 === 0) {
            console.log(`‚è±Ô∏è Timer: ${Math.floor(remainingSecs/60)} minutes remaining`);
        }
        
        // Timer expired!
        if (remainingSecs <= 0) {
            console.log('‚è±Ô∏è Timer expired! Closing Razorpay modal and cancelling booking...');
            clearInterval(timerInterval);
            
            // Close Razorpay modal if it's open
            if (razorpayInstance) {
                try {
                    razorpayInstance.close();
                } catch (e) {
                    console.error('Error closing Razorpay:', e);
                }
            }
            
            // CRITICAL: Cancel booking and release seats via API
            if (bookingId) {
                fetch(`/bookings/cancel/${bookingId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ 
                        reason: 'Payment timer expired',
                        showtime_id: {{ showtime.id }}
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Booking cancelled due to timer expiry:', data);
                })
                .catch(error => {
                    console.error('Error cancelling booking:', error);
                });
            }
            
            // Show alert
            alert('‚è±Ô∏è Payment window expired!\n\nYour 12-minute booking window has ended.\nSeats have been released.\n\nPlease select seats again.');
            
            // Redirect to seat selection
            window.location.href = `{% url 'select_seats' showtime.id %}`;
        }
        
        // Warning at 2 minutes
        if (remainingSecs === 120) {
            console.warn('‚ö†Ô∏è Only 2 minutes remaining!');
            // Could show a toast notification here
        }
        
        // Warning at 1 minute
        if (remainingSecs === 60) {
            console.warn('üö® Only 1 minute remaining!');
        }
    }, 1000); // Check every second
}

// üí≥ Open Razorpay payment modal with timer tracking
function openRazorpayModal(paymentData) {
    const options = {
        "key": paymentData.razorpay_key_id,
        "amount": paymentData.amount,
        "currency": paymentData.currency,
        "name": "Movie Booking System",
        "description": `${paymentData.movie_title} - ${paymentData.seat_count} seat(s)`,
        "order_id": paymentData.order_id,
        // ‚úÖ REMOVED: "redirect": true - We use MODAL mode so handler works!
        "prefill": {
            "name": paymentData.user_name,
            "email": paymentData.user_email
        },
        "theme": { "color": "#0d6efd" },
        // üéØ CRITICAL: This handler is called when payment succeeds
        "handler": function(response) {
            console.log('‚úÖ Payment successful! Response:', response);
            
            // Stop the timer first
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // üöÄ IMMEDIATELY hide the summary page to prevent ANY flash
            // This happens BEFORE any redirect, ensuring smooth transition
            document.body.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                            display: flex; align-items: center; justify-content: center; 
                            z-index: 999999; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <div style="text-align: center; color: white; padding: 40px;">
                        <div style="margin-bottom: 30px;">
                            <div style="width: 80px; height: 80px; border: 8px solid rgba(255,255,255,0.3); 
                                        border-top-color: white; border-radius: 50%; 
                                        animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        </div>
                        <h1 style="font-size: 36px; margin-bottom: 15px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            ‚úÖ Payment Successful!
                        </h1>
                        <p style="font-size: 18px; opacity: 0.95; margin-bottom: 10px;">
                            Redirecting to your ticket...
                        </p>
                        <p style="font-size: 14px; opacity: 0.8;">
                            Please wait while we prepare your booking details
                        </p>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            // Redirect to payment_success view for verification and ticket display
            const successUrl = `/bookings/${paymentData.booking_id}/payment/success/?razorpay_payment_id=${response.razorpay_payment_id}&razorpay_order_id=${response.razorpay_order_id}&razorpay_signature=${response.razorpay_signature}`;
            console.log('üîÑ Redirecting to:', successUrl);
            window.location.href = successUrl;
        },
        "modal": {
            "ondismiss": async function() {
                // User closed the payment modal - treat as cancellation
                console.log('Payment modal dismissed by user - cancelling booking');
                
                // Stop timer
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                
                // Cancel the booking and release seats immediately
                try {
                    const response = await fetch(`/bookings/cancel/${paymentData.booking_id}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ reason: 'User closed Razorpay modal' })
                    });
                    
                    const result = await response.json();
                    console.log('Booking cancellation result:', result);
                } catch (error) {
                    console.error('Error cancelling booking:', error);
                }
                
                // Show message and redirect to seat selection for new booking
                alert('‚ö†Ô∏è Payment cancelled.\n\nYour seats have been released.\nYou can select seats again to create a new booking.');
                window.location.href = `{% url 'select_seats' showtime.id %}`;
            }
        }
    };
    
    try {
        razorpayInstance = new Razorpay(options);
        razorpayInstance.open();
        
        // Start the 12-minute timer (720 seconds)
        // Use the actual expiry time if available, otherwise default to 720 seconds
        const expirySeconds = paymentData.expires_in_seconds || 720;
        startExpiryTimer(paymentData.booking_id, expirySeconds);
        
    } catch (error) {
        console.error('Razorpay error:', error);
        // Fallback: redirect to payment page
        alert('Could not open payment gateway. Redirecting to payment page...');
        window.location.href = paymentData.redirect_url;
    }
}

// üé¨ Main button click handler with direct Razorpay modal
document.getElementById('confirm-booking-btn').addEventListener('click', async function() {
    const showtimeId = "{{ showtime.id }}";
    const seatIds = JSON.parse(document.getElementById('seat-data').textContent);
    const btn = this;
    
    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating booking & opening payment...';
    
    const paymentData = await createBookingAndOpenPayment(showtimeId, seatIds);
    
    if (!paymentData.success) {
        // üö® ERROR: Booking creation failed
        btn.className = 'btn btn-danger btn-lg w-100 shadow';
        btn.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${paymentData.error}`;
        
        setTimeout(() => {
            btn.disabled = false;
            btn.className = 'btn btn-success btn-lg w-100 shadow';
            btn.innerHTML = 'Proceed to pay with Razorpay <i class="fas fa-arrow-right ms-2"></i>';
        }, 3000);
        return;
    }
    
    // ‚úÖ Booking created successfully - Mark in sessionStorage for refresh detection
    sessionStorage.setItem(`booking_created_${showtimeId}`, 'true');
    
    // Step 3: Handle mock payment (testing mode)
    if (paymentData.is_mock) {
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Simulating payment...';
        
        setTimeout(() => {
            const mockPaymentId = "pay_mock_" + Math.random().toString(36).substr(2, 9);
            const mockSignature = "sig_mock_verified";
            window.location.href = `${paymentData.callback_url}?razorpay_payment_id=${mockPaymentId}&razorpay_order_id=${paymentData.order_id}&razorpay_signature=${mockSignature}`;
        }, 1500);
        return;
    }
    
    // Step 4: Open Razorpay modal directly (Production mode)
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Opening Razorpay...';
    
    // Small delay to ensure Razorpay script is loaded
    setTimeout(() => {
        openRazorpayModal(paymentData);
        
        // Re-enable button after modal opens
        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = 'Proceed to pay with Razorpay <i class="fas fa-arrow-right ms-2"></i>';
        }, 1000);
    }, 300);
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
});

// üîÑ TAB-AWARE REFRESH DETECTION
// WHY: Distinguish between "opening in new tab" vs "refreshing same tab"
// sessionStorage is tab-specific, so perfect for this!

const showtimeId = "{{ showtime.id }}";
const tabAccessKey = `summary_tab_${showtimeId}`;
const bookingExistsOnServer = {{ booking|yesno:"true,false" }};

// Check if THIS TAB has accessed this summary page before
const tabAccessedBefore = sessionStorage.getItem(tabAccessKey);

if (tabAccessedBefore && bookingExistsOnServer) {
    // üö® REFRESH DETECTED: This tab accessed the page before AND booking exists
    console.warn('‚ö†Ô∏è Page refresh detected in same tab after booking creation');
    
    // Immediately cancel the booking and release seats
    const bookingId = {{ booking.id|default:"null" }};
    
    if (bookingId) {
        // Call backend to cancel booking and release seats
        fetch(`/bookings/cancel/${bookingId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 
                reason: 'User refreshed summary page',
                showtime_id: {{ showtime.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Booking cancelled due to refresh:', data);
        })
        .catch(error => {
            console.error('Error cancelling booking:', error);
        });
    }
    
    // Show error message to user immediately
    document.body.innerHTML = `
        <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
            <h1 style="color: #d32f2f;">‚ö†Ô∏è Page Refreshed</h1>
            <p style="font-size: 18px; color: #666;">
                Your booking session has expired due to page refresh.<br>
                All reserved seats have been released.
            </p>
            <a href="{% url 'select_seats' showtime.id %}" 
               style="display: inline-block; margin-top: 20px; padding: 12px 24px; 
                      background: #1976d2; color: white; text-decoration: none; 
                      border-radius: 4px; font-size: 16px;">
                Start New Booking
            </a>
        </div>
    `;
} else if (!tabAccessedBefore) {
    // ‚úÖ FIRST ACCESS in this tab: Mark it
    console.log('‚úÖ First access to summary page in this tab');
    sessionStorage.setItem(tabAccessKey, 'true');
    
    // If opening in new tab and booking exists, that's OK - allow it
    if (bookingExistsOnServer) {
        console.log('Booking exists - opened in new tab (allowed)');
    }
}
</script>
{% endblock %}
